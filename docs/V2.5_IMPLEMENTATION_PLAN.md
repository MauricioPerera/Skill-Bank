# ðŸš€ v2.5 Implementation Plan

**Target:** 6 weeks  
**Team Size:** 1 developer  
**Estimated Hours:** 120-150 hours

---

## Overview

v2.5 adds four major features to the Credentials Vault:

1. **Argon2id Support** (Week 1)
2. **Credential Caching** (Week 2)
3. **Audit Chain Verification** (Week 3)
4. **Just-in-Time Access** (Week 4)
5. **Integration & Polish** (Week 5-6)

---

## Week 1: Argon2id Support

### Goals
- âœ… Add Argon2id as optional KDF
- âœ… Maintain PBKDF2 backward compatibility
- âœ… Enable migration path

### Day 1: Setup & Interface Design

**Tasks:**
1. Install argon2 dependency
   ```bash
   npm install argon2
   npm install -D @types/argon2
   ```

2. Update `credentials.ts` types:
   - Add `KDFType`
   - Add `KDFParameters`
   - Add `KDFConfig`
   - Update `EncryptedCredential`

3. Create `src/skills/security/kdf.ts`:
   - `deriveKey()` function
   - `getDefaultKDF()` function
   - Default configs

**Acceptance:**
- [ ] Types compile without errors
- [ ] `kdf.ts` exports all required functions

---

### Day 2: Encryption Integration

**Tasks:**
1. Update `encryption.ts`:
   - Modify `encryptCredential()` to accept `kdfType` parameter
   - Call `deriveKey()` with appropriate KDF
   - Store KDF metadata in result

2. Update `decryptCredential()`:
   - Read KDF type from encrypted data
   - Default to PBKDF2 for legacy data
   - Call `deriveKey()` with correct KDF

**Acceptance:**
- [ ] Can encrypt with PBKDF2 (backward compatible)
- [ ] Can encrypt with Argon2id (new feature)
- [ ] Can decrypt both types

---

### Day 3: Credential Store Integration

**Tasks:**
1. Update database schema:
   - Add `kdf_type` column
   - Add `kdf_parameters` column
   - Add `kdf_version` column
   - Add `version` column

2. Update `credentialStore.ts`:
   - Store KDF metadata
   - Retrieve KDF metadata
   - Default to PBKDF2 for existing records

3. Create migration script:
   - `migrations/v2.5_add_kdf_fields.sql`

**Acceptance:**
- [ ] Database schema updated
- [ ] Can store credentials with KDF metadata
- [ ] Legacy credentials still work

---

### Day 4: Rotation with KDF Upgrade

**Tasks:**
1. Update `rotateCredential()`:
   - Add `upgradeKDF` option
   - Implement KDF upgrade logic
   - Log KDF upgrade in audit

2. Environment variable support:
   - `DEFAULT_KDF_TYPE`
   - Parse and validate

**Acceptance:**
- [ ] Can rotate credential with same KDF
- [ ] Can rotate credential with KDF upgrade
- [ ] Audit log shows KDF upgrade

---

### Day 5: Testing (Argon2id)

**Tasks:**
1. Create `encryption-argon2id.test.ts`:
   - Encrypt/decrypt with Argon2id (5 tests)
   - PBKDF2 backward compatibility (3 tests)
   - KDF migration (3 tests)
   - Parameter validation (4 tests)

2. Run full test suite:
   - Verify no v2.0 tests broken

**Acceptance:**
- [ ] 15 new tests passing
- [ ] All 216 v2.0 tests still passing
- [ ] Total: 231/231 tests

---

## Week 2: Credential Caching

### Goals
- âœ… Implement in-memory LRU cache
- âœ… Sliding TTL with auto-invalidation
- âœ… 10x performance improvement

### Day 1: Cache Implementation

**Tasks:**
1. Install LRU cache dependency:
   ```bash
   npm install lru-cache
   ```

2. Create `src/skills/cache/credentialCache.ts`:
   - `CredentialCache` class
   - `get()` method
   - `set()` method
   - `invalidate()` method
   - `clear()` method
   - `getStats()` method

3. Cache configuration:
   - `CredentialCacheConfig` interface
   - Default configuration
   - Environment variable parsing

**Acceptance:**
- [ ] `CredentialCache` class implemented
- [ ] All methods working
- [ ] Configuration via env vars

---

### Day 2: Integration with Retrieval

**Tasks:**
1. Update `credentialStore.ts`:
   - Initialize global cache instance
   - Check cache before decrypt
   - Store in cache after decrypt
   - Pass through audit logging

2. Verify cache key generation:
   - Per-entity caching
   - Global caching option

**Acceptance:**
- [ ] Cache hit returns immediately
- [ ] Cache miss triggers full decrypt
- [ ] Audit log includes `cached` field

---

### Day 3: Auto-Invalidation

**Tasks:**
1. Update `rotateCredential()`:
   - Call `cache.invalidate(credentialId)`
   - Log cache invalidation

2. Update `revokeCredential()`:
   - Call `cache.invalidate(credentialId)`
   - Log cache invalidation

3. Add version-based invalidation:
   - Store version with cached entry
   - Invalidate on version mismatch

**Acceptance:**
- [ ] Rotation invalidates cache
- [ ] Revocation invalidates cache
- [ ] Subsequent access requires decrypt

---

### Day 4: Cache Monitoring

**Tasks:**
1. Implement stats tracking:
   - Hits
   - Misses
   - Hit rate
   - Size
   - Evictions

2. Add API:
   - `getCacheStats()`
   - `clearCache()`
   - Export for monitoring

**Acceptance:**
- [ ] Stats tracked accurately
- [ ] API functions work
- [ ] Can export for monitoring

---

### Day 5: Testing (Caching)

**Tasks:**
1. Create `credentialCache.test.ts`:
   - Get/set operations (5 tests)
   - TTL expiration (3 tests)
   - Sliding window (3 tests)
   - LRU eviction (3 tests)
   - Invalidation (3 tests)
   - Stats tracking (3 tests)

2. Integration tests:
   - Cache miss â†’ decrypt â†’ cache set (1 test)
   - Cache hit â†’ immediate return (1 test)
   - Invalidation on rotation (1 test)

3. Performance benchmarks:
   - Measure cached vs uncached
   - Verify â‰¥10x improvement

**Acceptance:**
- [ ] 20 unit tests passing
- [ ] 3 integration tests passing
- [ ] Performance targets met
- [ ] Total: 254/254 tests

---

## Week 3: Audit Chain Verification

### Goals
- âœ… Blockchain-like chained hashing
- âœ… Forensic-grade tamper detection
- âœ… External verification support

### Day 1: Database Schema

**Tasks:**
1. Update audit log schema:
   - Add `chain_height` column
   - Add `entry_hash` column
   - Add `previous_hash` column
   - Add indexes

2. Create migration script:
   - `migrations/v2.5_add_audit_chain.sql`
   - Backfill `chain_height` for existing entries

**Acceptance:**
- [ ] Schema updated
- [ ] Indexes created
- [ ] Existing entries have chain_height

---

### Day 2: Hash Calculation

**Tasks:**
1. Update `auditLogger.ts`:
   - `calculateEntryHash()` function
   - `getPreviousHash()` function
   - Update `logAuditEntry()` to include chain data

2. Genesis entry handling:
   - First entry has previous_hash = "0" * 64

**Acceptance:**
- [ ] Can calculate entry hash
- [ ] Can retrieve previous hash
- [ ] Genesis entry handled correctly

---

### Day 3: Chain Verification

**Tasks:**
1. Implement `verifyAuditChain()`:
   - Iterate through entries
   - Verify hash links
   - Verify entry hashes
   - Detect missing sequences
   - Return detailed result

2. Add `AuditChainVerificationResult` interface

**Acceptance:**
- [ ] Can verify complete chain
- [ ] Detects broken links
- [ ] Detects tampered entries
- [ ] Detects missing entries

---

### Day 4: Export & External Verification

**Tasks:**
1. Implement `exportAuditChain()`:
   - JSON format
   - CSV format
   - Optional credential filter

2. Create standalone verification script:
   - `tools/verify-audit-chain.ts`
   - Can verify exported chain offline

**Acceptance:**
- [ ] Can export to JSON
- [ ] Can export to CSV
- [ ] Standalone verifier works

---

### Day 5: Testing (Audit Chain)

**Tasks:**
1. Create `auditChain.test.ts`:
   - Hash calculation (3 tests)
   - Chain building (3 tests)
   - Verification (4 tests)
   - Tamper detection (3 tests)
   - Export (2 tests)

2. Performance tests:
   - Verify 1000 entry chain
   - Verify 10,000 entry chain
   - Measure time and memory

**Acceptance:**
- [ ] 15 tests passing
- [ ] Performance acceptable
- [ ] Total: 269/269 tests

---

## Week 4: Just-in-Time Access

### Goals
- âœ… Temporal credential elevation
- âœ… Risk-based access control
- âœ… Zero-standing-privilege model

### Day 1: Database & Types

**Tasks:**
1. Create `jit_access_grants` table:
   - See schema in design doc
   - Add indexes

2. Create types in `credentials.ts`:
   - `JITAccessRequest`
   - `JITAccessGrant`
   - `JITAccessError`

**Acceptance:**
- [ ] Table created
- [ ] Types defined
- [ ] Compiles without errors

---

### Day 2: Risk Scoring

**Tasks:**
1. Create `src/skills/security/jitAccess.ts`:
   - `calculateRiskScore()` function
   - Factor in:
     - Duration
     - Priority
     - Environment
     - Entity history
     - Time of day

2. Risk thresholds:
   - MFA threshold (60)
   - Approval threshold (80)

**Acceptance:**
- [ ] Risk scoring implemented
- [ ] Returns 0-100
- [ ] All factors considered

---

### Day 3: JIT Access Flow

**Tasks:**
1. Implement `requestJITAccess()`:
   - Calculate risk score
   - Validate MFA if required
   - Check for approval if required
   - Create grant
   - Store in database
   - Log audit entry

2. Implement `revokeJITAccess()`:
   - Mark grant as revoked
   - Invalidate cache
   - Log audit entry

**Acceptance:**
- [ ] Can request JIT access
- [ ] Risk-based requirements enforced
- [ ] Grants stored correctly

---

### Day 4: Integration with Access Control

**Tasks:**
1. Update `hasAccess()`:
   - Check permanent policies (v2.0)
   - Check JIT grants (v2.5 new)
   - Return true if either valid

2. Implement auto-expiration:
   - `expireJITGrants()` function
   - Run every minute
   - Mark expired grants

3. Add to retrieval flow:
   - JIT grants checked before decrypt

**Acceptance:**
- [ ] JIT grants work alongside permanent policies
- [ ] Auto-expiration runs
- [ ] Expired grants deny access

---

### Day 5: Testing (JIT Access)

**Tasks:**
1. Create `jitAccess.test.ts`:
   - Risk scoring (3 tests)
   - Request flow (3 tests)
   - MFA validation (2 tests)
   - Approval workflow (2 tests)

2. Integration tests:
   - Request â†’ grant â†’ access â†’ expire (2 tests)
   - High-risk with MFA (1 test)
   - Denial based on risk (1 test)

**Acceptance:**
- [ ] 10 unit tests passing
- [ ] 4 integration tests passing
- [ ] Total: 283/283 tests

---

## Week 5: Integration & Polish

### Goals
- âœ… End-to-end testing
- âœ… Performance validation
- âœ… Bug fixes

### Day 1: E2E Tests

**Tasks:**
1. Create `v2.5-integration.test.ts`:
   - Complete v2.5 flow (1 test)
   - High-risk JIT scenario (1 test)
   - Mixed KDF environment (1 test)
   - Cache + Argon2id performance (1 test)
   - Audit chain verification (1 test)
   - JIT expiration (1 test)

**Acceptance:**
- [ ] 6 E2E tests passing
- [ ] Total: 289/289 tests

---

### Day 2: Performance Benchmarks

**Tasks:**
1. Create `benchmarks/v2.5-performance.ts`:
   - Argon2id vs PBKDF2
   - Cached vs uncached retrieval
   - High-frequency scenario
   - Chain verification (1000, 10000 entries)
   - JIT request latency

2. Run benchmarks:
   - Compare to v2.0 baseline
   - Verify targets met

**Acceptance:**
- [ ] All benchmarks run
- [ ] Performance targets met:
  - Cached retrieval â‰¥10x faster
  - Chain verification < 100ms for 1000 entries
  - JIT request < 10ms

---

### Day 3: Migration Testing

**Tasks:**
1. Test migration path:
   - v2.0 database â†’ v2.5 migration
   - Verify no data loss
   - Verify backward compatibility

2. Test gradual rollout:
   - PBKDF2 â†’ Argon2id transition
   - Some credentials cached, others not
   - Mix of permanent and JIT access

**Acceptance:**
- [ ] Migration script works
- [ ] No data loss
- [ ] All v2.0 features still work

---

### Day 4: Bug Fixes & Edge Cases

**Tasks:**
1. Review all tests for flakiness
2. Fix any TypeScript errors
3. Handle edge cases:
   - Empty cache
   - First audit entry (genesis)
   - Concurrent JIT requests
   - Cache eviction during access

**Acceptance:**
- [ ] No TypeScript errors
- [ ] All tests stable
- [ ] Edge cases handled

---

### Day 5: Demo Script

**Tasks:**
1. Create `examples/demo-v2.5.ts`:
   - Store credential with Argon2id
   - Cache performance comparison
   - Request JIT access
   - Verify audit chain
   - Export audit trail

2. Add npm script:
   ```json
   "demo:v2.5": "tsx examples/demo-v2.5.ts"
   ```

**Acceptance:**
- [ ] Demo runs successfully
- [ ] Shows all v2.5 features
- [ ] Clear output with explanations

---

## Week 6: Documentation & Release

### Goals
- âœ… Complete documentation
- âœ… Migration guide
- âœ… Release preparation

### Day 1: API Documentation

**Tasks:**
1. Update `docs/CREDENTIALS_GUIDE.md`:
   - Argon2id usage
   - Cache configuration
   - JIT access workflow
   - Audit chain verification

2. Add code examples for each feature

**Acceptance:**
- [ ] All new APIs documented
- [ ] Examples included
- [ ] Clear and concise

---

### Day 2: Migration Guide

**Tasks:**
1. Create `docs/MIGRATION_v2.0_to_v2.5.md`:
   - Breaking changes (none)
   - New features (opt-in)
   - Migration steps
   - Rollback procedure
   - FAQ

2. Include SQL migration scripts

**Acceptance:**
- [ ] Migration guide complete
- [ ] Step-by-step instructions
- [ ] Covers all scenarios

---

### Day 3: Security Documentation

**Tasks:**
1. Update `docs/SECURITY.md`:
   - Argon2id security properties
   - Cache security considerations
   - JIT access security model
   - Audit chain tamper-proofing

2. Add threat model for new features

**Acceptance:**
- [ ] Security doc updated
- [ ] All risks documented
- [ ] Mitigations explained

---

### Day 4: Release Notes

**Tasks:**
1. Create `RELEASE_NOTES_v2.5.md`:
   - What's new
   - Performance improvements
   - Breaking changes (none)
   - Migration guide link
   - Known issues

2. Update `README.md`:
   - Add v2.5 to roadmap as complete
   - Update stats (289 tests, etc.)
   - Add v2.5 quick start

**Acceptance:**
- [ ] Release notes complete
- [ ] README updated
- [ ] All links working

---

### Day 5: Release Preparation

**Tasks:**
1. Final test run:
   ```bash
   npm test
   npx tsc --noEmit
   npm run demo:v2.5
   ```

2. Create git tag:
   ```bash
   git tag -a v2.5.0 -m "Release v2.5: Core Security & Performance"
   git push skillbank v2.5.0
   ```

3. Create GitHub Release:
   - Use release notes
   - Attach benchmarks
   - Link to migration guide

**Acceptance:**
- [ ] All tests passing (289/289)
- [ ] No TypeScript errors
- [ ] Demo runs successfully
- [ ] Tag created
- [ ] GitHub Release published

---

## Test Coverage Summary

| Feature | Unit Tests | Integration | E2E | Total |
|---------|-----------|-------------|-----|-------|
| v2.0 (baseline) | 82 | 22 | 6 | 110 |
| v2.0 (audit trail) | 16 | 0 | 0 | 16 |
| v2.0 (total) | 98 | 22 | 6 | 126 |
| **Argon2id** | 15 | 3 | 1 | 19 |
| **Caching** | 20 | 3 | 1 | 24 |
| **Audit Chain** | 15 | 0 | 1 | 16 |
| **JIT Access** | 10 | 4 | 3 | 17 |
| **v2.5 Total** | **158** | **32** | **12** | **202** |

**Note:** Some tests are shared/reused, actual new tests = 76

---

## Acceptance Criteria (v2.5)

### Functional

- [ ] All 289 tests passing (100%)
- [ ] Argon2id encrypt/decrypt working
- [ ] Cache hit rate â‰¥80% in high-frequency scenarios
- [ ] Audit chain verification detects tampering
- [ ] JIT access grants auto-expire

### Performance

- [ ] Cached retrieval â‰¥10x faster than uncached
- [ ] Argon2id overhead mitigated by caching
- [ ] Chain verification < 100ms for 1000 entries
- [ ] JIT request < 10ms

### Security

- [ ] All STRIDE threats mitigated
- [ ] Audit chain cryptographically verifiable
- [ ] JIT access enforces risk-based controls
- [ ] Cache doesn't expose plaintext externally

### Quality

- [ ] 0 TypeScript errors
- [ ] 0 breaking changes from v2.0
- [ ] Complete documentation
- [ ] Working demo

### Release

- [ ] Git tag created
- [ ] GitHub Release published
- [ ] Release notes complete
- [ ] Migration guide available

---

## Risks & Mitigation

### Risk: Argon2id Too Slow

**Mitigation:**
- Configurable memory cost
- Caching reduces frequency
- Can fallback to PBKDF2

### Risk: Cache Security Concerns

**Mitigation:**
- Documented clearly
- Can be disabled
- TTL limits exposure
- Process-level isolation

### Risk: JIT Complexity

**Mitigation:**
- Opt-in feature
- Clear examples
- Gradual rollout

### Risk: Schedule Slippage

**Mitigation:**
- 6 weeks is conservative
- Can ship features incrementally
- Week 5-6 are buffer

---

## Success Metrics

v2.5 is successful if:

1. âœ… 289/289 tests passing (100%)
2. âœ… â‰¥10x cached retrieval performance
3. âœ… 0 breaking changes
4. âœ… All security threats mitigated
5. âœ… Complete documentation

---

## Next Steps After v2.5

1. Monitor adoption metrics:
   - % credentials using Argon2id
   - Cache hit rate in production
   - JIT access usage

2. Gather feedback:
   - Performance in real workloads
   - Security concerns
   - Developer experience

3. Plan v2.6:
   - Extended credential types (JWT, SSH, TOTP, OAuth)
   - Based on v2.5 learnings

---

**Document Version:** 1.0  
**Last Updated:** December 2025  
**Status:** âœ… Ready to Execute

